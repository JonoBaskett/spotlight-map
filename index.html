<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Spotlight Ranked Firms Interactive Map</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>

<style>
  /* --- Layout & brand --- */
  body {
    margin:0;
    font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
    background: #002b49; /* replaced purple gradient */
    min-height:100vh;
  }
  .container {
    display:flex;
    height:100vh;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
  }
  .map-container {
    flex:1;
    position:relative;
    background:#f8f9fa;
  }
  .sidebar {
    width:400px;
    background:#fff;
    border-left:3px solid #002b49; /* brand navy */
    padding:20px;
    overflow-y:auto;
    box-shadow:-5px 0 15px rgba(0,0,0,.10);
  }
  .header {
    background:#002b49; /* brand navy */
    color:#fff;
    padding:20px;
    text-align:center;
    margin:-20px -20px 20px -20px;
  }
  .header h1 { margin:0; font-size:1.5em; font-weight:300; }

  /* --- Top toggleable filters bar --- */
  .filters-wrap {
    position:absolute;
    top:16px;
    left:50%;
    transform:translateX(-50%);
    z-index:1500;
    width:min(920px, 92vw);
  }
  .filters-toggle {
    width:100%;
    padding:10px 14px;
    border:2px solid #002b49;
    border-radius:10px;
    background:#002b49;
    color:#fff;
    font-weight:600;
    cursor:pointer;
    transition:.2s;
  }
  .filters-toggle:hover { transform: translateY(-1px); box-shadow:0 5px 15px rgba(0,43,73,.25); }
  .filters-panel {
    display:none; /* set to block if you want open by default */
    margin-top:10px;
    background:#fff;
    border:1px solid #e1e5e9;
    border-radius:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.12);
    padding:14px;
  }
  .filters-grid {
    display:grid;
    grid-template-columns: 1fr 1fr auto;
    gap:12px;
    align-items:end;
  }
  @media (max-width: 900px) {
    .filters-grid {
      grid-template-columns: 1fr;
    }
  }

  /* --- Form controls (brand) --- */
  .control-group label { display:block; font-weight:600; color:#333; margin-bottom:6px; }
  select, input[type=text], button {
    width:100%;
    padding:10px;
    border:2px solid #e1e5e9;
    border-radius:8px;
    font-size:14px;
    transition:.2s;
    background:#fff;
  }
  select:focus, input[type=text]:focus, button:focus {
    outline:none;
    border-color:#002b49;
    box-shadow:0 0 0 3px rgba(0,43,73,.12);
  }
  .btn-primary {
    background:#002b49;
    color:#fff;
    border:none;
    cursor:pointer;
    font-weight:600;
  }
  .btn-primary:hover { transform:translateY(-1px); box-shadow:0 5px 15px rgba(0,43,73,.25); }

  /* --- Table --- */
  .firms-table {
    background:#f8f9fa;
    border-radius:10px;
    padding:15px;
    max-height:440px;
    overflow-y:auto;
  }
  .firms-table h3 {
    margin-top:0;
    color:#333;
    border-bottom:2px solid #002b49;
    padding-bottom:10px;
  }
  .row {
    background:#fff;
    padding:12px;
    margin-bottom:8px;
    border-radius:6px;
    border-left:4px solid #002b49;
    box-shadow:0 2px 4px rgba(0,0,0,.06);
    cursor:pointer;
  }
  .row-title { font-weight:600; color:#333; display:flex; justify-content:space-between; gap:10px; }
  .muted { color:#666; font-size:.9em; }
  .badge { display:inline-block; background:#eef2ff; color:#002b49; padding:2px 8px; border-radius:999px; font-size:.8em; margin-left:6px; }

  /* --- Map --- */
  svg { width:100%; height:100%; cursor:pointer; }
  .state { stroke:#fff; stroke-width:1px; transition:.2s; }
  .state:hover { stroke-width:2px; }
  .city-circle { fill:#ff6b35; stroke:#fff; stroke-width:2px; cursor:pointer; transition:.2s; }
  .city-circle:hover { fill:#ff8c42; }
  .city-label-bg { fill:#fff; stroke:#002b49; stroke-opacity:.15; stroke-width:1; rx:6; ry:6; pointer-events:none; }
  .city-label-text { font-size:12px; font-weight:600; fill:#002b49; pointer-events:none; }

  /* Legend removed */
  .legend { display:none !important; }

  /* Map utility UI */
  .back-button { position:absolute; top:20px; left:20px; z-index:1000; display:none; }
  .state-title {
    position:absolute; top:20px; right:20px;
    background:rgba(255,255,255,.95); padding:10px 20px; border-radius:8px;
    font-size:1.2em; font-weight:600; color:#333; display:none;
  }

  /* Autocomplete */
  .ac-wrap { position:relative; }
  .autocomplete {
    position:absolute; top:100%; left:0; right:0; background:#fff;
    border:1px solid #e1e5e9; border-radius:8px; max-height:240px; overflow:auto;
    z-index:2000; display:none; box-shadow:0 8px 20px rgba(0,0,0,.08);
  }
  .ac-item { padding:10px; border-bottom:1px solid #f1f3f5; cursor:pointer; }
  .ac-item:hover { background:#f8fafc; }
  .ac-title { font-weight:600; color:#111827; }
  .ac-sub { font-size:.85em; color:#4b5563; margin-top:2px; }
</style>
</head>

<body>
  <div class="container">
    <div class="map-container">

      <!-- Toggleable top filters -->
      <div class="filters-wrap">
        <button id="toggleFilters" class="filters-toggle">Filters &amp; search ▾</button>
        <div id="filtersPanel" class="filters-panel">
          <div class="filters-grid">
            <div class="control-group">
              <label for="practiceArea">Filter by Practice Area</label>
              <select id="practiceArea">
                <option value="__all__">All Practice Areas</option>
                <option value="Antitrust">Antitrust</option>
                <option value="Artifical Intelligence">Artifical Intelligence</option>
                <option value="Bankruptcy & Restructuring">Bankruptcy & Restructuring</option>
                <option value="Construction">Construction</option>
                <option value="Corporate Compliance">Corporate Compliance</option>
                <option value="Corporate/Commercial">Corporate/Commercial</option>
                <option value="Energy & Natural Resources">Energy & Natural Resources</option>
                <option value="Energy & Projects">Energy & Projects</option>
                <option value="Environment">Environment</option>
                <option value="FinTech">FinTech</option>
                <option value="Franchising">Franchising</option>
                <option value="Government Relations">Government Relations</option>
                <option value="Healthcare">Healthcare</option>
                <option value="Immigration">Immigration</option>
                <option value="Insurance">Insurance</option>
                <option value="Intellectual Property">Intellectual Property</option>
                <option value="International Arbitration">International Arbitration</option>
                <option value="International Trade">International Trade</option>
                <option value="Labor & Employment">Labor & Employment</option>
                <option value="Litigation: General Commercial">Litigation: General Commercial</option>
                <option value="Litigation: White-Collar Crime & Government Investigations">Litigation: White-Collar Crime & Government Investigations</option>
                <option value="Media & Entertainment">Media & Entertainment</option>
                <option value="Medical Malpractice">Medical Malpractice</option>
                <option value="Mergers & Acqusitions">Mergers & Acqusitions</option>
                <option value="Personal Injury">Personal Injury</option>
                <option value="Privacy & Data Security">Privacy & Data Security</option>
                <option value="Products Liability">Products Liability</option>
                <option value="Real Estate">Real Estate</option>
              </select>
            </div>

            <div class="control-group ac-wrap">
              <label for="searchBox">Search firms</label>
              <input id="searchBox" type="text" placeholder="Start typing a firm name..." />
              <div id="autocomplete" class="autocomplete"></div>
            </div>

            <div>
              <button id="resetBtn" class="btn-primary">Reset View</button>
            </div>
          </div>
        </div>
      </div>
      <!-- /filters -->

      <button class="back-button" onclick="resetToUSView()">← Back to US Map</button>
      <div class="state-title" id="stateTitle"></div>
      <svg id="map"></svg>
      <!-- legend removed -->
    </div>

    <div class="sidebar">
      <div class="header"><h1>Spotlight Ranked Firms</h1></div>

      <!-- old .controls removed to free space -->

      <div class="firms-table" id="firmsTable">
        <h3>Select a state to view ranked firms</h3>
        <div class="row">
          <div class="muted">Click any coloured state to zoom in. Use the filter or search to focus the map.</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ==== DATA & HELPERS (unchanged from your original) ==== */
/* low/high colours already brand aligned */
const lowColor = d3.color("#CBE1F8");
const highColor = d3.color("#002b49");
function interpColor(t) {
  const r = lowColor.r + (highColor.r - lowColor.r) * t;
  const g = lowColor.g + (highColor.g - lowColor.g) * t;
  const b = lowColor.b + (highColor.b - lowColor.b) * t;
  return d3.rgb(r,g,b).formatHex();
}

let currentState = null;
let currentPA = "__all__";

const svg = d3.select("#map");
const width = 960, height = 600;
const projection = d3.geoAlbersUsa().scale(1300).translate([width/2, height/2]);
const path = d3.geoPath().projection(projection);

const viewport = svg.append("g").attr("class","viewport");
const statesG  = viewport.append("g").attr("class","states");
const citiesG  = viewport.append("g").attr("class","cities");
const labelsG  = viewport.append("g").attr("class","labels");

/* ---- your data block stays as-is (shortened here for brevity) ---- */
/* BEGIN: data injected from CSV at build time */
// ... your existing data array/object here ...
/* END: data block */

/* Utility functions you already had (firmCount, cityFirmCount, etc.) */
function firmCount(stateName, practiceArea) {
  const st = data[stateName]; if (!st) return 0;
  let total = 0;
  Object.values(st.cities).forEach(city => {
    const firms = city.firms || [];
    if (!practiceArea || practiceArea === "__all__") total += firms.length;
    else total += firms.filter(f => (f.practiceAreas||[]).includes(practiceArea)).length;
  });
  return total;
}
function cityFirmCount(stateName, cityName, practiceArea) {
  const city = data[stateName]?.cities?.[cityName]; if (!city) return 0;
  const firms = city.firms || [];
  if (!practiceArea || practiceArea === "__all__") return firms.length;
  return firms.filter(f => (f.practiceAreas||[]).includes(practiceArea)).length;
}

function computeCountExtent() {
  const counts = Object.keys(data).map(s => firmCount(s, currentPA));
  const max = d3.max(counts) || 1;
  return [0,max];
}

let kScale = 1; // current zoom scale
function baseRadius() { return 6; }
function scaledRadius() { return Math.max(2, baseRadius() / Math.sqrt(kScale)); }
function labelFontPx() { return Math.max(6, 12 / (kScale*kScale)); } // shrink as you zoom in

d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(function(us) {
  const states = topojson.feature(us, us.objects.states);

  statesG.selectAll(".state")
    .data(states.features)
    .enter().append("path")
    .attr("class","state")
    .attr("d", path)
    .attr("fill", d => getStateFill(getStateName(d.id)))
    .on("click", function(event, d) {
      const name = getStateName(d.id);
      if (firmCount(name, currentPA) > 0) zoomToState(d, name);
    });

  drawCities();
  initControls();
});

function getStateFill(stateName) {
  const [minC,maxC] = computeCountExtent();
  const count = firmCount(stateName, currentPA);
  if (count <= 0) return "#e8e8e8";
  const t = maxC===0 ? 0 : count/maxC;
  return interpColor(t);
}
function redrawStates() {
  statesG.selectAll(".state").attr("fill", d => getStateFill(getStateName(d.id)));
}
function drawCities() {
  citiesG.selectAll("*").remove();
  labelsG.selectAll("*").remove();

  Object.keys(data).forEach(stateName => {
    const cities = data[stateName].cities || {};
    Object.keys(cities).forEach(cityName => {
      const city = cities[cityName];
      const count = cityFirmCount(stateName, cityName, currentPA);
      if (count <= 0) return;
      const proj = projection(city.coords);
      if (!proj) return;
      const cx = proj[0], cy = proj[1];

      const g = citiesG.append("g").attr("transform", `translate(${cx},${cy})`);
      g.append("circle")
        .attr("class","city-circle")
        .attr("r", scaledRadius())
        .on("click", () => showCity(stateName, cityName))
        .on("mouseenter", () => toggleLabel(stateName, cityName, true))
        .on("mouseleave", () => toggleLabel(stateName, cityName, false))
        .append("title")
        .text(`${cityName}, ${stateName} — ${count} ranked firm(s)`);

      const labelG = labelsG.append("g")
        .attr("data-key", `${stateName}:::${cityName}`)
        .attr("transform", `translate(${cx+8},${cy-8})`)
        .style("visibility", "hidden");

      const text = labelG.append("text")
        .attr("class","city-label-text")
        .style("font-size", labelFontPx() + "px")
        .text(`${cityName}`);

      const bbox = text.node().getBBox();
      labelG.insert("rect", "text")
        .attr("class","city-label-bg")
        .attr("x", bbox.x - 6)
        .attr("y", bbox.y - 4)
        .attr("width", bbox.width + 12)
        .attr("height", bbox.height + 8);
    });
  });
}
function toggleLabel(stateName, cityName, show) {
  labelsG.selectAll(`g[data-key="${stateName}:::${cityName}"]`).style("visibility", show ? "visible" : "hidden");
}

/* --- Sidebar population --- */
function updateSidebar(stateName) {
  const tableDiv = document.getElementById('firmsTable');
  const st = data[stateName];
  if (!st) { tableDiv.innerHTML = `<h3>Select a state to view ranked firms</h3>`; return; }

  let html = `<h3>${stateName}</h3>`;
  Object.keys(st.cities).sort().forEach(cityName => {
    const firms = st.cities[cityName].firms || [];
    const count = currentPA && currentPA !== "__all__"
      ? firms.filter(f => (f.practiceAreas||[]).includes(currentPA)).length
      : firms.length;
    if (count <= 0) return;

    html += `
      <div class="row" data-city="${cityName}">
        <div class="row-title"><span>${cityName}</span><span class="badge">${count}</span></div>
        <div class="muted">Click to view firms</div>
      </div>`;
  });
  tableDiv.innerHTML = html;

  tableDiv.querySelectorAll('.row').forEach(el => {
    el.addEventListener('click', () => {
      const ct = el.getAttribute("data-city");
      showCity(stateName, ct);
    });
  });
}
function showCity(stateName, cityName) {
  const tableDiv = document.getElementById('firmsTable');
  const city = data[stateName]?.cities?.[cityName];
  if (!city) return;

  let firms = city.firms || [];
  if (currentPA && currentPA !== "__all__") {
    firms = firms.filter(f => (f.practiceAreas||[]).includes(currentPA));
  }

  if (firms.length === 0) {
    tableDiv.innerHTML = `
      <h3>${cityName}, ${stateName}</h3>
      <div class="row"><div class="muted">There are currently no firms ranked in this practice area and city</div></div>`;
    return;
  }

  let html = `<h3>${cityName}, ${stateName}</h3>`;
  firms.forEach(f => {
    const pa = (f.practiceAreas || []).join(", ");
    html += `
      <div class="row">
        <div class="row-title"><span>${f.name}</span></div>
        <div class="muted">${pa}</div>
      </div>`;
  });
  tableDiv.innerHTML = html;
}

/* --- Controls wiring (IDs preserved) --- */
function initControls() {
  // toggle filters panel
  const panel = document.getElementById('filtersPanel');
  document.getElementById('toggleFilters').addEventListener('click', () => {
    panel.style.display = panel.style.display === 'none' || !panel.style.display ? 'block' : 'none';
  });

  document.getElementById('practiceArea').addEventListener('change', (e) => {
    currentPA = e.target.value;
    redrawStates();
    drawCities();
    if (currentState) updateSidebar(currentState);
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    document.getElementById('practiceArea').value = "__all__";
    document.getElementById('searchBox').value = "";
    document.getElementById('autocomplete').style.display = "none";
    currentPA = "__all__";
    resetToUSView();
    redrawStates();
    drawCities();
  });

  // Predictive firm search
  const ac = document.getElementById('autocomplete');
  const input = document.getElementById('searchBox');
  input.addEventListener('input', () => {
    const q = input.value.trim().toLowerCase();
    if (!q) { ac.style.display = "none"; ac.innerHTML = ""; return; }
    const matches = firmIndex.filter(f => f.firm.toLowerCase().includes(q)).slice(0, 12);
    if (matches.length === 0) { ac.style.display = "none"; ac.innerHTML = ""; return; }
    ac.innerHTML = matches.map(m => {
      const pa = (m.practiceAreas||[]).join(" • ");
      return `<div class="ac-item" data-state="${m.state}" data-city="${m.city}">
                <div class="ac-title">${m.firm}</div>
                <div class="ac-sub">${m.city}, ${m.state} — ${pa}</div>
              </div>`;
    }).join("");
    ac.style.display = "block";
    ac.querySelectorAll(".ac-item").forEach(el => {
      el.addEventListener('click', () => {
        const st = el.getAttribute('data-state');
        const ct = el.getAttribute('data-city');
        input.value = "";
        ac.style.display = "none";
        focusOnStateAndCity(st, ct);
      });
    });
  });
  input.addEventListener('blur', () => setTimeout(() => { ac.style.display = "none"; }, 150));
}

/* --- Zoom, pan, label sizing --- */
function focusOnStateAndCity(stateName, cityName) {
  const pathSel = statesG.selectAll(".state").filter(d => getStateName(d.id) === stateName);
  if (!pathSel.empty()) {
    const d = pathSel.datum();
    zoomToState(d, stateName);
    panToCity(stateName, cityName);
    showCity(stateName, cityName);
  }
}
function getStateName(stateId) {
  const stateNames = {
    "01":"Alabama","02":"Alaska","04":"Arizona","05":"Arkansas","06":"California",
    "08":"Colorado","09":"Connecticut","10":"Delaware","11":"District of Columbia",
    "12":"Florida","13":"Georgia","15":"Hawaii","16":"Idaho","17":"Illinois",
    "18":"Indiana","19":"Iowa","20":"Kansas","21":"Kentucky","22":"Louisiana",
    "23":"Maine","24":"Maryland","25":"Massachusetts","26":"Michigan","27":"Minnesota",
    "28":"Mississippi","29":"Missouri","30":"Montana","31":"Nebraska","32":"Nevada",
    "33":"New Hampshire","34":"New Jersey","35":"New Mexico","36":"New York",
    "37":"North Carolina","38":"North Dakota","39":"Ohio","40":"Oklahoma",
    "41":"Oregon","42":"Pennsylvania","44":"Rhode Island","45":"South Carolina",
    "46":"South Dakota","47":"Tennessee","48":"Texas","49":"Utah","50":"Vermont",
    "51":"Virginia","53":"Washington","54":"West Virginia","55":"Wisconsin","56":"Wyoming",
    "72":"Puerto Rico"
  };
  return stateNames[String(stateId).padStart(2,'0')];
}
const zoomBehavior = d3.zoom()
  .scaleExtent([1, 8])
  .on("zoom", (event) => {
    kScale = event.transform.k;
    viewport.attr("transform", event.transform);
    citiesG.selectAll(".city-circle").attr("r", scaledRadius());
    labelsG.selectAll(".city-label-text").style("font-size", labelFontPx() + "px");
    labelsG.selectAll("g").each(function() {
      const g = d3.select(this);
      const txt = g.select(".city-label-text").node();
      if (!txt) return;
      const bbox = txt.getBBox();
      g.select("rect.city-label-bg")
        .attr("x", bbox.x - 6)
        .attr("y", bbox.y - 4)
        .attr("width", bbox.width + 12)
        .attr("height", bbox.height + 8);
    });
  });
svg.call(zoomBehavior);

/* --- Zoom helpers (as in your original) --- */
function zoomToState(d, name) {
  const [[x0, y0], [x1, y1]] = path.bounds(d);
  const dx = x1 - x0, dy = y1 - y0, x = (x0 + x1) / 2, y = (y0 + y1) / 2;
  const scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height)));
  const translate = [width / 2 - scale * x, height / 2 - scale * y];

  svg.transition().duration(750).call(
    zoomBehavior.transform,
    d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
  );

  currentState = name;
  document.querySelector('.back-button').style.display = 'block';
  const stTitle = document.getElementById('stateTitle');
  stTitle.textContent = name;
  stTitle.style.display = 'block';
  updateSidebar(name);
}
function panToCity(stateName, cityName) {
  const city = data[stateName]?.cities?.[cityName];
  if (!city) return;
  const proj = projection(city.coords);
  if (!proj) return;
  const [cx, cy] = proj;
  const t = d3.zoomTransform(svg.node());
  svg.transition().duration(500).call(
    zoomBehavior.transform,
    d3.zoomIdentity.translate(width/2 - t.k * cx, height/2 - t.k * cy).scale(t.k)
  );
}
function resetToUSView() {
  currentState = null;
  document.querySelector('.back-button').style.display = 'none';
  document.querySelector('#stateTitle').style.display = 'none';
  svg.transition().duration(750).call(zoomBehavior.transform, d3.zoomIdentity);
  document.getElementById('firmsTable').innerHTML = `
    <h3>Select a state to view ranked firms</h3>
    <div class="row"><div class="muted">Click any coloured state to zoom in. Use the filter or search to focus the map.</div></div>`;
}

/* --- Firm index used by autocomplete (kept as in your file) --- */
// const firmIndex = [...]; // keep your existing index here

</script>
</body>
</html>
